<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estudio Barber House</title>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/png" href="favicon.png">
</head>
<body>
    <!-- Header -->
    <header>
        <div class="header-contenedor">
            <h1>Estudio Barber House</h1>
            <nav>
                <a href="#servicios">Servicios</a>
                <a href="#contacto">Contacto</a>
                <a href="#agendar">Agendar Cita</a>
            </nav>
        </div>
    </header>

    <!-- Hero -->
    <section id="inicio" class="hero">
        <h2>Luce con presencia</h2>
        <p>Reserva tu cita y disfruta de la mejor barber√≠a de San Pedro de los Milagros.</p>
        <a href="#agendar" class="boton">Agenda tu cita</a>
    </section>

    <!-- Servicios -->
    <section id="servicios">
        <h2>Nuestros Servicios</h2>
        <div class="servicios-container">
            <div class="servicio">
                <i class="fa-solid fa-scissors"></i>
                <h3>Corte</h3>
                <p class="precio">$20.000</p>
                <p>El estilo que m√°s te guste, con acabado profesional.</p>
            </div>
            <div class="servicio">
                <i class="fa-solid fa-eye"></i>
                <h3>Cejas</h3>
                <p class="precio">$5.000</p>
                <p>Definici√≥n y limpieza de cejas con t√©cnica precisa.</p>
            </div>
            <div class="servicio">
                <i class="fa-solid fa-user"></i>
                <h3>Barba</h3>
                <p class="precio">$12.000</p>
                <p>Perfilado, afeitado y arreglo completo de barba.</p>
            </div>
            <div class="servicio">
                <i class="fa-solid fa-mask-face"></i>
                <h3>Mascarilla 5 pasos</h3>
                <p class="precio">$10.000</p>
                <p>Exfoliaci√≥n, hidrataci√≥n y mascarillas para limpiar y rejuvenecer la piel.</p>
            </div>
        </div>
    </section>

    <!-- Contacto -->
    <section id="contacto">
        <h2>Cont√°ctanos</h2>
        <p>ü™Æ Cr 51 CL 49+9 Atras de la iglesia</p>
        <p>üìß Instagram: XXX </p>
    </section>

    <!-- Formulario de cita -->
    <section id="agendar" class="formulario-cita">
        <h2>Agendar Cita</h2>
        <p>Selecciona el servicio, elige una hora disponible y deja tus datos üíà</p>

        <form id="formCita">
            <input type="text" id="nombre" placeholder="Tu nombre" required>
            <input type="tel" id="telefono" placeholder="Tu n√∫mero de tel√©fono" required>
            
            <select id="servicio" required>
                <option value="">Selecciona un servicio</option>
                <option value="Corte">Corte</option>
                <option value="Cejas">Cejas</option>
                <option value="Barba">Barba</option>
                <option value="Mascarilla 5 pasos">Mascarilla 5 pasos</option>
            </select>

            <input type="date" id="fecha" required>
            
            <select id="hora" required>
                <option value="">Selecciona una hora</option>
            </select>

            <button type="submit"><i class="fa-solid fa-calendar-check"></i> Reservar cita</button>
        </form>

        <p id="estado" style="margin-top:15px;"></p>
    </section>

<script>
const SHEET_URL = "https://script.google.com/macros/s/AKfycbwa5upKmZ6lHQXTVx14TbchtSw0qYUCsUapSAqzHJdEALx1fxhlpQTqFlcqnR42bRf_Cg/exec";

// ===================
// Inicializar fecha m√≠nima (hoy)
// ===================
document.addEventListener('DOMContentLoaded', function() {
    const fechaInput = document.getElementById("fecha");
    const hoy = new Date().toISOString().split('T')[0];
    fechaInput.min = hoy;
});

// ===================
// JSONP para cargar horas
// ===================
function cargarHoras() {
    const fecha = document.getElementById("fecha").value;
    const selectHora = document.getElementById("hora");
    
    if (!fecha) {
        selectHora.innerHTML = "<option value=''>Primero selecciona una fecha</option>";
        return;
    }

    selectHora.innerHTML = "<option value=''>Cargando horas...</option>";

    // Limpiar callback anterior si existe
    if (window.procesarHoras) {
        delete window.procesarHoras;
    }

    // Crear callback √∫nico para evitar conflictos
    const callbackName = 'procesarHoras_' + new Date().getTime();
    window[callbackName] = function(horasOcupadas) {
        procesarHorasReal(horasOcupadas);
        delete window[callbackName];
    };

    // Crear script din√°mico para JSONP
    const script = document.createElement("script");
    script.src = `${SHEET_URL}?fecha=${fecha}&callback=${callbackName}`;
    script.onerror = function() {
        selectHora.innerHTML = "<option value=''>Error al cargar horas</option>";
        console.error("Error cargando las horas disponibles");
    };
    
    document.body.appendChild(script);
}

// Funci√≥n real para procesar las horas
function procesarHorasReal(horasOcupadas) {
    const selectHora = document.getElementById("hora");
    
    // Horas disponibles del negocio
    const horasDisponibles = [
        "11:00 AM", "12:00 PM", "1:00 PM", "2:00 PM", 
        "3:00 PM", "4:00 PM", "5:00 PM", "6:00 PM", "7:00 PM"
    ];
    
    selectHora.innerHTML = "<option value=''>Selecciona una hora</option>";
    
    horasDisponibles.forEach(hora => {
        const option = document.createElement("option");
        option.value = hora;
        
        if (horasOcupadas && horasOcupadas.includes(hora)) {
            option.disabled = true;
            option.textContent = hora + " (Ocupado)";
            option.style.color = "#999";
        } else {
            option.textContent = hora;
        }
        
        selectHora.appendChild(option);
    });
    
    // Si no hay horas disponibles
    if (selectHora.options.length === 1) {
        selectHora.innerHTML = "<option value=''>No hay horas disponibles</option>";
    }
}

// Manejar errores del JSONP
window.procesarHoras = procesarHorasReal;

// Evento al cambiar la fecha
document.getElementById("fecha").addEventListener("change", cargarHoras);

// ===================
// Enviar cita con POST
// ===================
document.getElementById("formCita").addEventListener("submit", async e => {
    e.preventDefault();
    
    const data = {
        nombre: document.getElementById("nombre").value,
        telefono: document.getElementById("telefono").value,
        servicio: document.getElementById("servicio").value,
        fecha: document.getElementById("fecha").value,
        hora: document.getElementById("hora").value
    };

    // Validaci√≥n b√°sica
    if (!data.hora || data.hora.includes("Ocupado") || data.hora === "Selecciona una hora") {
        document.getElementById("estado").textContent = "‚ùå Por favor selecciona una hora v√°lida";
        return;
    }

    const estado = document.getElementById("estado");
    estado.textContent = "Enviando...";
    estado.style.color = "#333";

    try {
        const res = await fetch(SHEET_URL, {
            method: "POST",
            body: JSON.stringify(data),
            headers: { "Content-Type": "application/json" }
        });

        const text = await res.text();
        if(text.includes("OK")) {
            estado.textContent = "‚úÖ Cita registrada con √©xito";
            estado.style.color = "green";
            document.getElementById("formCita").reset();
            // Recargar horas para actualizar disponibilidad
            if (document.getElementById("fecha").value) {
                cargarHoras();
            }
        } else {
            estado.textContent = "‚ùå Error al registrar la cita";
            estado.style.color = "red";
        }
    } catch (error) {
        console.error("Error:", error);
        estado.textContent = "‚ùå Error de conexi√≥n al registrar la cita";
        estado.style.color = "red";
    }
});
// Agrega esta funci√≥n temporal para debug
function debugCargaHoras() {
    const fecha = document.getElementById("fecha").value;
    console.log("Fecha seleccionada:", fecha);
    
    // Test directo
    fetch(`${SHEET_URL}?fecha=${fecha}`)
        .then(r => r.json())
        .then(horas => console.log("Horas ocupadas:", horas))
        .catch(err => console.error("Error fetch:", err));
}

// Llama a esta funci√≥n desde la consola del navegador para probar
    
</script>
</body>
</html>
